<div id="map"></div>

<div class="stars-overlay"></div>

<div class="top-bar">
  <div class="kp-badge">
    KP NOW <span id="kp-value">--</span>
  </div>

  <div class="sightings-wrapper">
    <button class="list-btn" onclick="toggleSightings()">
      ğŸŒŒ Sightings <span id="sightings-arrow">â–¼</span>
    </button>

    <div class="sightings-dropdown" id="sightings-dropdown">
      <div class="sightings-title">Recent Sightings</div>
      <div id="sightings-list">
        <div class="sighting-empty">No sightings in the last 30 minutes</div>
      </div>
    </div>
  </div>
</div>

<div class="bottom-nav">
  <%= link_to weather_path, class: "nav-btn" do %>
    <span>ğŸŒ¤ï¸</span>
    <span>Weather</span>
  <% end %>

  <%= link_to new_aurora_path, class: "nav-btn-main" do %>
    âœ¦
  <% end %>

  <%= link_to forecast_path, class: "nav-btn" do %>
    <span>ğŸ”­</span>
    <span>Forecast</span>
  <% end %>
</div>

<script>
  document.addEventListener('turbo:load', () => {
  if (document.getElementById('map')._leaflet_id) return;

  const map = L.map('map', { zoomControl: false }).setView([20, 0], 2);
  setTimeout(() => { map.invalidateSize(); }, 100);

  L.tileLayer('https://api.mapbox.com/styles/v1/mapbox/dark-v11/tiles/256/{z}/{x}/{y}@2x?access_token=<%= ENV["MAPBOX_API_KEY"] %>', {
    attribution: 'Â© <a href="https://www.mapbox.com/">Mapbox</a> Â© <a href="https://www.openstreetmap.org/">OpenStreetMap</a>',
    tileSize: 256,
    maxZoom: 19
  }).addTo(map);

  const auroras = <%= raw @auroras_json %>;

  auroras.forEach(aurora => {
    const el = document.createElement('div');
    el.className = 'aurora-ping';

    L.marker([aurora.lat, aurora.lng], {
      icon: L.divIcon({ className: '', html: el.outerHTML, iconSize: [40, 40] })
    })
    .addTo(map)
    .bindPopup(`
      <div style="font-family:'Inter',sans-serif; min-width:150px;">
        <div style="color:#34d399; font-weight:600; margin-bottom:4px;">
          ğŸŒŒ Aurora spotted
        </div>
        <div style="color:#a78bfa; font-size:12px; margin-bottom:6px;">
          â± ${aurora.minutes_ago === 0 ? 'Just now' : aurora.minutes_ago + ' min ago'}
        </div>
        ${aurora.description
          ? `<div style="color:#ffffff; font-size:13px; margin-bottom:8px;">${aurora.description}</div>`
          : `<div style="color:#6b7280; font-size:12px; font-style:italic; margin-bottom:8px;">No description added</div>`
        }
        <a href="/auroras/${aurora.id}" style="display:block; text-align:center; background: linear-gradient(135deg, #7c3aed, #34d399); color:white; padding:6px 12px; border-radius:8px; font-size:12px; text-decoration:none;">
          View details â†’
        </a>
      </div>
    `);
  });

  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;

      map.setView([lat, lng], 6);

      fetch('/geolocation', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify({ latitude: lat, longitude: lng })
      });

      fetch(`/forecast/kp_now?lat=${lat}&lng=${lng}`)
        .then(r => r.json())
        .then(data => {
          document.getElementById('kp-value').textContent = data.kp ?? '--';
        });
    });
  }

  const sightingsList = document.getElementById('sightings-list');
  if (auroras.length > 0) {
    sightingsList.innerHTML = auroras.map(a => `
      <a href="/auroras/${a.id}" class="sighting-item">
        <span class="sighting-dot">ğŸŒŒ</span>
        <div class="sighting-info">
          <span class="sighting-time">
            ${a.minutes_ago === 0 ? 'Just now' : a.minutes_ago + ' min ago'}
          </span>
          ${a.description
            ? `<span class="sighting-desc">${a.description}</span>`
            : `<span class="sighting-desc no-desc">No description</span>`
          }
        </div>
      </a>
    `).join('');
  }

  function toggleSightings() {
    const dropdown = document.getElementById('sightings-dropdown');
    const arrow = document.getElementById('sightings-arrow');
    const isOpen = dropdown.classList.contains('open');
    dropdown.classList.toggle('open');
    arrow.textContent = isOpen ? 'â–¼' : 'â–²';
  }

  document.addEventListener('click', e => {
    const wrapper = document.querySelector('.sightings-wrapper');
    if (!wrapper.contains(e.target)) {
      document.getElementById('sightings-dropdown').classList.remove('open');
      document.getElementById('sightings-arrow').textContent = 'â–¼';
    }
  });
</script>
