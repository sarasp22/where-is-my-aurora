<div class="page-container">

  <div class="page-header">
    <%= link_to root_path, class: "back-btn" do %>
      â† Back
    <% end %>
    <h1 class="page-title">âœ¦ Add Sighting</h1>
  </div>

  <%= form_with model: @aurora, url: auroras_path, local: true, html: { multipart: true, class: "aurora-form" } do |f| %>

    <!-- Posizione -->
    <div class="form-card">
      <div class="form-label">ğŸ“ Location</div>
      <div class="location-display">
        <span id="location-text">Detecting your position...</span>
      </div>
      <%= f.hidden_field :latitude, value: @lat, id: "aurora_latitude" %>
      <%= f.hidden_field :longitude, value: @lng, id: "aurora_longitude" %>
    </div>

    <!-- Descrizione -->
    <div class="form-card">
      <div class="form-label">ğŸ“ Description (optional)</div>
      <%= f.text_area :description,
          placeholder: "Describe what you see... colors, intensity, shape",
          class: "form-textarea",
          rows: 3 %>
    </div>

    <!-- Foto -->
    <div class="form-card">
      <div class="form-label">ğŸ“¸ Photo (optional)</div>
      <div class="photo-upload-area" id="photo-area">
        <input type="file" name="aurora[photo]" id="aurora_photo"
               accept="image/*" capture="environment"
               class="photo-input" onchange="previewPhoto(this)">
        <label for="aurora_photo" class="photo-label">
          <div id="photo-preview-container">
            <span class="photo-icon">ğŸ“·</span>
            <span class="photo-text">Take a photo or choose from gallery</span>
          </div>
        </label>
        <img id="photo-preview" src="" style="display:none; width:100%; border-radius:12px; margin-top:12px;">
      </div>
    </div>

    <!-- Submit -->
    <button type="submit" class="submit-btn">
      ğŸŒŒ Report Aurora
    </button>

  <% end %>

</div>

<script>
  // Geolocalizzazione precisa
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;

      document.getElementById('aurora_latitude').value = lat;
      document.getElementById('aurora_longitude').value = lng;
      document.getElementById('location-text').textContent =
        `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
    }, () => {
      document.getElementById('location-text').textContent = 'Unable to detect location';
    });
  }

  // Preview foto
  function previewPhoto(input) {
    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = e => {
        const preview = document.getElementById('photo-preview');
        preview.src = e.target.result;
        preview.style.display = 'block';
        document.getElementById('photo-preview-container').style.display = 'none';
      };
      reader.readAsDataURL(input.files[0]);
    }
  }
</script>
